{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - {{ restaurante.nome }}{% endblock %}

{% block extra_head %}
<style>
    .checkout-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .checkout-section {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .loading-cep {
        display: none;
        color: #007bff;
    }
    
    .cep-error {
        color: #dc3545;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="checkout-container">
    <div class="row">
        <div class="col-md-8">
            <!-- Teste CEP -->
            <div class="checkout-section">
                <h5>Teste de CEP</h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <label for="cep" class="form-label">CEP</label>
                        <input type="text" 
                               class="form-control" 
                               id="cep" 
                               name="cep" 
                               placeholder="00000-000" 
                               maxlength="9">
                        <div class="loading-cep">üîÑ Buscando CEP...</div>
                        <div class="cep-error"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" id="buscar-cep" class="btn btn-primary d-block">
                            Buscar CEP
                        </button>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-8">
                        <label for="logradouro" class="form-label">Logradouro</label>
                        <input type="text" class="form-control" id="logradouro" name="logradouro" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="numero" class="form-label">N√∫mero</label>
                        <input type="text" class="form-control" id="numero" name="numero">
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="bairro" class="form-label">Bairro</label>
                        <input type="text" class="form-control" id="bairro" name="bairro" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="cidade" class="form-label">Cidade</label>
                        <input type="text" class="form-control" id="cidade" name="cidade" readonly>
                    </div>
                    <div class="col-md-2">
                        <label for="estado" class="form-label">Estado</label>
                        <input type="text" class="form-control" id="estado" name="estado" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
console.log('üîß [DEBUG] Script do checkout iniciado');

// Teste direto na p√°gina
window.testarCEPDireto = function() {
    console.log('üß™ [TESTE] Testando CEP direto...');
    
    const cepInput = document.getElementById('cep');
    const loadingEl = document.querySelector('.loading-cep');
    const errorEl = document.querySelector('.cep-error');
    
    console.log('Elements:', { cepInput: !!cepInput, loadingEl: !!loadingEl, errorEl: !!errorEl });
    
    if (loadingEl) loadingEl.style.display = 'block';
    if (errorEl) errorEl.innerHTML = '';
    
    fetch('https://viacep.com.br/ws/01310100/json/')
        .then(response => response.json())
        .then(data => {
            console.log('‚úÖ API Response:', data);
            if (loadingEl) loadingEl.style.display = 'none';
            
            if (!data.erro) {
                const logradouro = document.getElementById('logradouro');
                const bairro = document.getElementById('bairro');
                const cidade = document.getElementById('cidade');
                const estado = document.getElementById('estado');
                
                if (logradouro) logradouro.value = data.logradouro || '';
                if (bairro) bairro.value = data.bairro || '';
                if (cidade) cidade.value = data.localidade || '';
                if (estado) estado.value = data.uf || '';
                
                if (errorEl) errorEl.innerHTML = '<span style="color: green;">‚úÖ CEP encontrado: ' + data.logradouro + '</span>';
                
                console.log('‚úÖ Campos preenchidos!');
            }
        })
        .catch(error => {
            console.error('‚ùå Erro:', error);
            if (loadingEl) loadingEl.style.display = 'none';
            if (errorEl) errorEl.textContent = 'Erro: ' + error.message;
        });
};

function buscarCEP() {
    console.log('üîç [CEP] Fun√ß√£o buscarCEP chamada');
    
    const cepInput = document.getElementById('cep');
    const loadingEl = document.querySelector('.loading-cep');
    const errorEl = document.querySelector('.cep-error');
    
    if (!cepInput) {
        console.error('‚ùå Campo CEP n√£o encontrado');
        return;
    }
    
    const cep = cepInput.value.replace(/\D/g, '');
    console.log('CEP limpo:', cep);
    
    if (cep.length !== 8) {
        console.warn('CEP inv√°lido');
        if (errorEl) errorEl.textContent = 'Digite um CEP v√°lido com 8 d√≠gitos';
        return;
    }
    
    // Mostrar loading
    if (loadingEl) loadingEl.style.display = 'block';
    if (errorEl) errorEl.innerHTML = '';
    
    console.log('üåê Fazendo requisi√ß√£o para ViaCEP...');
    
    fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(response => {
            console.log('üì° Response recebido:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üì¶ Dados recebidos:', data);
            
            if (loadingEl) loadingEl.style.display = 'none';
            
            if (data.erro) {
                console.error('‚ùå CEP n√£o encontrado');
                if (errorEl) errorEl.textContent = 'CEP n√£o encontrado';
                return;
            }
            
            // Preencher campos
            const logradouro = document.getElementById('logradouro');
            const bairro = document.getElementById('bairro');
            const cidade = document.getElementById('cidade');
            const estado = document.getElementById('estado');
            
            if (logradouro) logradouro.value = data.logradouro || '';
            if (bairro) bairro.value = data.bairro || '';
            if (cidade) cidade.value = data.localidade || '';
            if (estado) estado.value = data.uf || '';
            
            if (errorEl) errorEl.innerHTML = '<span style="color: green;">‚úÖ CEP encontrado com sucesso!</span>';
            
            console.log('‚úÖ Campos preenchidos com sucesso!');
        })
        .catch(error => {
            console.error('‚ùå Erro na requisi√ß√£o:', error);
            if (loadingEl) loadingEl.style.display = 'none';
            if (errorEl) errorEl.textContent = 'Erro ao buscar CEP: ' + error.message;
        });
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ [INIT] DOM carregado, inicializando checkout...');
    
    const buscarBtn = document.getElementById('buscar-cep');
    const cepInput = document.getElementById('cep');
    
    console.log('Bot√£o buscar:', !!buscarBtn);
    console.log('Campo CEP:', !!cepInput);
    
    if (buscarBtn) {
        buscarBtn.addEventListener('click', function() {
            console.log('üî¥ [CLICK] Bot√£o clicado!');
            buscarCEP();
        });
        console.log('‚úÖ Event listener adicionado ao bot√£o');
    } else {
        console.error('‚ùå Bot√£o buscar n√£o encontrado!');
    }
    
    if (cepInput) {
        // M√°scara para CEP
        cepInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.replace(/^(\d{5})(\d)/, '$1-$2');
            }
            e.target.value = value;
        });
        
        // Buscar automaticamente quando terminar de digitar
        cepInput.addEventListener('blur', function() {
            const cep = this.value.replace(/\D/g, '');
            if (cep.length === 8) {
                console.log('üîç [AUTO] Buscando CEP automaticamente:', cep);
                buscarCEP();
            }
        });
        
        console.log('‚úÖ Event listeners adicionados ao campo CEP');
    } else {
        console.error('‚ùå Campo CEP n√£o encontrado!');
    }
    
    console.log('‚úÖ [INIT] Checkout inicializado com sucesso!');
    console.log('üí° [INFO] Digite testarCEPDireto() no console para testar');
});
</script>
{% endblock %}
        color: #e74c3c;
        font-size: 1.1rem;
    }
    
    .total-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
    }
    
    .total-section .row {
        margin-bottom: 10px;
    }
    
    .total-final {
        font-size: 1.4rem;
        font-weight: 700;
        border-top: 2px solid rgba(255,255,255,0.3);
        padding-top: 15px;
        margin-top: 15px;
    }
    
    .form-check-input:checked {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    .btn-finalizar {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        padding: 15px 40px;
        font-size: 1.2rem;
        font-weight: 600;
        border-radius: 50px;
        transition: all 0.3s ease;
    }
    
    .btn-finalizar:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }
    
    .loading-cep {
        display: none;
    }
    
    .cep-error {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 5px;
    }
    
    @media (max-width: 768px) {
        .checkout-container {
            padding: 10px;
        }
        
        .item-carrinho {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="checkout-container">
    <div class="row">
        <!-- Coluna esquerda - Formul√°rio -->
        <div class="col-lg-8">
            <form method="post" id="checkout-form">
                {% csrf_token %}
                
                <!-- Dados Pessoais -->
                <div class="checkout-section">
                    <h3 class="section-title">
                        <i class="bi bi-person-circle me-2"></i>
                        Dados Pessoais
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nome" class="form-label">Nome completo *</label>
                            <input type="text" class="form-control" name="nome" id="nome" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="celular" class="form-label">Celular *</label>
                            <input type="tel" class="form-control" name="celular" id="celular" 
                                   placeholder="(11) 99999-9999" required>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="email" class="form-label">E-mail</label>
                            <input type="email" class="form-control" name="email" id="email" 
                                   placeholder="seu@email.com">
                        </div>
                    </div>
                </div>

                <!-- Tipo de Entrega -->
                <div class="checkout-section">
                    <h3 class="section-title">
                        <i class="bi bi-truck me-2"></i>
                        Tipo de Entrega
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_entrega" 
                                       id="delivery" value="delivery" checked>
                                <label class="form-check-label" for="delivery">
                                    <strong>Delivery</strong><br>
                                    <small class="text-muted">Taxa: R$ {{ restaurante.taxa_entrega|floatformat:2 }}</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_entrega" 
                                       id="retirada" value="retirada">
                                <label class="form-check-label" for="retirada">
                                    <strong>Retirada no Local</strong><br>
                                    <small class="text-muted">Sem taxa de entrega</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Endere√ßo de Entrega -->
                <div class="checkout-section" id="endereco-section">
                    <h3 class="section-title">
                        <i class="bi bi-geo-alt me-2"></i>
                        Endere√ßo de Entrega
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="cep" class="form-label">CEP *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="cep" id="cep" 
                                       placeholder="00000-000" maxlength="9">
                                <button class="btn btn-outline-secondary" type="button" id="buscar-cep">
                                    <i class="bi bi-search"></i>
                                </button>
                                <button class="btn btn-outline-danger d-none" type="button" id="cancelar-cep">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                            <div class="loading-cep" style="display: none;">
                                <small class="text-muted">
                                    <i class="bi bi-hourglass-split"></i> Buscando CEP...
                                </small>
                            </div>
                            <div class="cep-error"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="logradouro" class="form-label">Rua/Avenida *</label>
                            <input type="text" class="form-control" name="logradouro" id="logradouro" required>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="numero" class="form-label">N√∫mero *</label>
                            <input type="text" class="form-control" name="numero" id="numero" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="complemento" class="form-label">Complemento</label>
                            <input type="text" class="form-control" name="complemento" id="complemento" 
                                   placeholder="Apto, sala, etc.">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="bairro" class="form-label">Bairro *</label>
                            <input type="text" class="form-control" name="bairro" id="bairro" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="cidade" class="form-label">Cidade *</label>
                            <input type="text" class="form-control" name="cidade" id="cidade" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="ponto_referencia" class="form-label">Ponto de Refer√™ncia</label>
                            <input type="text" class="form-control" name="ponto_referencia" id="ponto_referencia" 
                                   placeholder="Ex: pr√≥ximo ao posto de gasolina">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="estado" class="form-label">Estado</label>
                            <input type="text" class="form-control" name="estado" id="estado" readonly>
                        </div>
                    </div>
                </div>

                <!-- Forma de Pagamento -->
                <div class="checkout-section">
                    <h3 class="section-title">
                        <i class="bi bi-credit-card me-2"></i>
                        Forma de Pagamento
                    </h3>
                    
                    <div class="row">
                        {% for value, label in formas_pagamento %}
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="forma_pagamento" 
                                       id="{{ value }}" value="{{ value }}" {% if forloop.first %}checked{% endif %}>
                                <label class="form-check-label" for="{{ value }}">
                                    {{ label }}
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Campo para troco (s√≥ aparece se dinheiro for selecionado) -->
                    <div id="troco-section" style="display: none;">
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="troco_para" class="form-label">Troco para quanto?</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" step="0.01" class="form-control" 
                                           name="troco_para" id="troco_para" placeholder="0,00">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observa√ß√µes -->
                <div class="checkout-section">
                    <h3 class="section-title">
                        <i class="bi bi-chat-text me-2"></i>
                        Observa√ß√µes
                    </h3>
                    
                    <div class="mb-3">
                        <textarea class="form-control" name="observacoes" id="observacoes" 
                                  rows="3" placeholder="Observa√ß√µes adicionais para o seu pedido..."></textarea>
                    </div>
                </div>
            </form>
        </div>

        <!-- Coluna direita - Resumo do Pedido -->
        <div class="col-lg-4">
            <div class="checkout-section">
                <h3 class="section-title">
                    <i class="bi bi-cart-check me-2"></i>
                    Resumo do Pedido
                </h3>
                
                {% if itens_carrinho %}
                    {% for item in itens_carrinho %}
                    <div class="item-carrinho">
                        <div class="item-info">
                            <h6>{{ item.produto.nome }}</h6>
                            <small class="text-muted">
                                {{ item.quantidade }}x R$ {{ item.preco|floatformat:2 }}
                            </small>
                            {% if item.personalizacoes %}
                                <div class="mt-1">
                                    {% for perso in item.personalizacoes %}
                                        <small class="badge bg-light text-dark me-1">{{ perso.nome }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if item.observacoes %}
                                <div class="mt-1">
                                    <small class="text-muted fst-italic">{{ item.observacoes }}</small>
                                </div>
                            {% endif %}
                        </div>
                        <div class="item-preco">
                            R$ {{ item.subtotal|floatformat:2 }}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-cart-x display-1 text-muted"></i>
                        <p class="text-muted mt-3">Seu carrinho est√° vazio</p>
                        <a href="{% url 'loja:cardapio' restaurante.slug %}" class="btn btn-primary">
                            Ver Card√°pio
                        </a>
                    </div>
                {% endif %}
                
                {% if itens_carrinho %}
                <div class="total-section mt-4">
                    <div class="row">
                        <div class="col-8">Subtotal:</div>
                        <div class="col-4 text-end">R$ {{ total_carrinho|floatformat:2 }}</div>
                    </div>
                    <div class="row" id="taxa-entrega-row">
                        <div class="col-8">Taxa de entrega:</div>
                        <div class="col-4 text-end" id="taxa-value">R$ {{ taxa_entrega|floatformat:2 }}</div>
                    </div>
                    <div class="row total-final">
                        <div class="col-8">Total:</div>
                        <div class="col-4 text-end" id="total-final">R$ {{ total_final|floatformat:2 }}</div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" form="checkout-form" class="btn btn-finalizar btn-lg">
                            <i class="bi bi-check-circle me-2"></i>
                            Finalizar Pedido
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
console.log('üîß [DEBUG] Script do checkout iniciado');

// Teste direto na p√°gina
window.testarCEPDireto = function() {
    console.log('üß™ [TESTE] Testando CEP direto...');
    
    const cepInput = document.getElementById('cep');
    const loadingEl = document.querySelector('.loading-cep');
    const errorEl = document.querySelector('.cep-error');
    
    console.log('Elements:', { cepInput: !!cepInput, loadingEl: !!loadingEl, errorEl: !!errorEl });
    
    if (loadingEl) loadingEl.style.display = 'block';
    
    fetch('https://viacep.com.br/ws/01310100/json/')
        .then(response => response.json())
        .then(data => {
            console.log('‚úÖ API Response:', data);
            if (loadingEl) loadingEl.style.display = 'none';
            
            if (!data.erro) {
                const logradouro = document.getElementById('logradouro');
                const bairro = document.getElementById('bairro');
                const cidade = document.getElementById('cidade');
                const estado = document.getElementById('estado');
                
                if (logradouro) logradouro.value = data.logradouro || '';
                if (bairro) bairro.value = data.bairro || '';
                if (cidade) cidade.value = data.localidade || '';
                if (estado) estado.value = data.uf || '';
                
                if (errorEl) errorEl.innerHTML = '<span style="color: green;">‚úÖ CEP encontrado: ' + data.logradouro + '</span>';
                
                console.log('‚úÖ Campos preenchidos!');
            }
        })
        .catch(error => {
            console.error('‚ùå Erro:', error);
            if (loadingEl) loadingEl.style.display = 'none';
            if (errorEl) errorEl.textContent = 'Erro: ' + error.message;
        });
};

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ [INIT] DOM carregado, inicializando checkout...');
    
    const buscarBtn = document.getElementById('buscar-cep');
    const cepInput = document.getElementById('cep');
    
    console.log('Bot√£o buscar:', !!buscarBtn);
    console.log('Campo CEP:', !!cepInput);
    
    if (buscarBtn && cepInput) {
        buscarBtn.addEventListener('click', function() {
            console.log('üî¥ [CLICK] Bot√£o clicado!');
            const cep = cepInput.value.replace(/\D/g, '');
            console.log('CEP:', cep);
            
            if (cep.length === 8) {
                testarCEPDireto();
            } else {
                console.warn('CEP inv√°lido');
            }
        });
        console.log('‚úÖ Event listener adicionado');
    } else {
        console.error('‚ùå Elementos n√£o encontrados!');
    }
});
    
    // Verificar se os elementos existem
    const celularInput = document.getElementById('celular');
    const cepInput = document.getElementById('cep');
    const buscarBtn = document.getElementById('buscar-cep');
    const cancelarBtn = document.getElementById('cancelar-cep');
    const loadingEl = document.querySelector('.loading-cep');
    const errorEl = document.querySelector('.cep-error');
    
    console.log('üìã [INIT] Elementos encontrados:');
    console.log('  - celularInput:', !!celularInput);
    console.log('  - cepInput:', !!cepInput);
    console.log('  - buscarBtn:', !!buscarBtn);
    console.log('  - cancelarBtn:', !!cancelarBtn);
    console.log('  - loadingEl:', !!loadingEl);
    console.log('  - errorEl:', !!errorEl);
    
    // Ocultar loading inicialmente
    if (loadingEl) {
        loadingEl.style.display = 'none';
    }
    
    // Fun√ß√£o de busca CEP
    function buscarCEP(cep) {
        console.log('üîç [CEP] === INICIANDO BUSCA ===');
        console.log('üîç [CEP] CEP recebido:', cep);
        console.log('üîç [CEP] Tipo do CEP:', typeof cep);
        console.log('üîç [CEP] Length:', cep.length);
        
        const loadingEl = document.querySelector('.loading-cep');
        const errorEl = document.querySelector('.cep-error');
        
        console.log('üîç [CEP] Loading element encontrado:', !!loadingEl);
        console.log('üîç [CEP] Error element encontrado:', !!errorEl);
        
        if (loadingEl) {
            console.log('üîç [CEP] Exibindo loading...');
            loadingEl.style.display = 'block';
            loadingEl.style.visibility = 'visible';
            console.log('‚úÖ [CEP] Loading exibido - display:', loadingEl.style.display);
        } else {
            console.error('‚ùå [CEP] Loading element n√£o encontrado!');
        }
        
        if (errorEl) {
            errorEl.textContent = '';
            errorEl.innerHTML = '';
        }
        
        // Valida√ß√£o b√°sica
        if (!cep || cep.length !== 8) {
            console.error('‚ùå [CEP] CEP inv√°lido:', cep);
            if (errorEl) errorEl.textContent = 'CEP deve ter 8 d√≠gitos';
            if (loadingEl) loadingEl.style.display = 'none';
            return;
        }
        
        console.log('üì° [CEP] Fazendo requisi√ß√£o para ViaCEP...');
        const url = `https://viacep.com.br/ws/${cep}/json/`;
        console.log('üì° [CEP] URL:', url);
        
        // Fazer requisi√ß√£o com timeout manual
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            console.log('‚è∞ [CEP] Timeout atingido - cancelando requisi√ß√£o');
            controller.abort();
        }, 10000);
        
        fetch(url, {
            signal: controller.signal,
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            clearTimeout(timeoutId);
            console.log('ÔøΩ [CEP] Response recebida');
            console.log('üì® [CEP] Status:', response.status);
            console.log('üì® [CEP] StatusText:', response.statusText);
            console.log('üì® [CEP] OK:', response.ok);
            console.log('üì® [CEP] Headers:', [...response.headers.entries()]);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üì¶ [CEP] === DADOS RECEBIDOS ===');
            console.log('üì¶ [CEP] Data completa:', data);
            console.log('üì¶ [CEP] Tipo:', typeof data);
            console.log('üì¶ [CEP] Erro na resposta:', data.erro);
            
            // Ocultar loading
            if (loadingEl) {
                console.log('üîç [CEP] Ocultando loading...');
                loadingEl.style.display = 'none';
                console.log('‚úÖ [CEP] Loading ocultado');
            }
            
            if (data.erro) {
                console.warn('‚ö†Ô∏è [CEP] CEP n√£o encontrado na base ViaCEP');
                if (errorEl) {
                    errorEl.textContent = 'CEP n√£o encontrado';
                    errorEl.style.color = 'red';
                }
                return;
            }
            
            console.log('‚úÖ [CEP] CEP encontrado! Preenchendo campos...');
            
            // Preencher campos
            const campos = {
                'logradouro': data.logradouro || '',
                'bairro': data.bairro || '',
                'cidade': data.localidade || '',
                'estado': data.uf || ''
            };
            
            console.log('üìù [CEP] Campos a preencher:', campos);
            
            Object.keys(campos).forEach(campoId => {
                const elemento = document.getElementById(campoId);
                console.log(`üìù [CEP] Campo ${campoId}:`, !!elemento, '- Valor:', campos[campoId]);
                if (elemento) {
                    elemento.value = campos[campoId];
                    console.log(`‚úÖ [CEP] Campo ${campoId} preenchido com:`, elemento.value);
                } else {
                    console.error(`‚ùå [CEP] Campo ${campoId} n√£o encontrado!`);
                }
            });
            
            if (errorEl) {
                errorEl.innerHTML = '<span style="color: green;">‚úÖ CEP encontrado com sucesso!</span>';
                errorEl.style.color = 'green';
                setTimeout(() => {
                    errorEl.textContent = '';
                }, 4000);
            }
            
            // Foco no n√∫mero
            const numeroEl = document.getElementById('numero');
            if (numeroEl) {
                numeroEl.focus();
                console.log('‚úÖ [CEP] Foco movido para campo n√∫mero');
            }
            
            console.log('‚úÖ [CEP] === BUSCA CONCLU√çDA COM SUCESSO ===');
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('‚ùå [CEP] === ERRO NA BUSCA ===');
            console.error('‚ùå [CEP] Erro completo:', error);
            console.error('‚ùå [CEP] Message:', error.message);
            console.error('‚ùå [CEP] Name:', error.name);
            console.error('‚ùå [CEP] Stack:', error.stack);
            
            // Ocultar loading
            if (loadingEl) {
                console.log('üîç [CEP] Ocultando loading ap√≥s erro...');
                loadingEl.style.display = 'none';
            }
            
            if (errorEl) {
                errorEl.textContent = `Erro ao buscar CEP: ${error.message}`;
                errorEl.style.color = 'red';
            }
            
            console.log('‚ùå [CEP] === FIM DO ERRO ===');
        });
    }
    
    // Event listener para o bot√£o buscar
    if (buscarBtn) {
        buscarBtn.addEventListener('click', function() {
            console.log('üî¥ [EVENT] Bot√£o buscar clicado');
            
            if (!cepInput) {
                console.error('‚ùå [EVENT] Campo CEP n√£o encontrado');
                return;
            }
            
            const cep = cepInput.value.replace(/\D/g, '');
            console.log('üìù [EVENT] CEP extra√≠do:', cep, 'length:', cep.length);
            
            if (cep.length !== 8) {
                console.warn('‚ö†Ô∏è [EVENT] CEP inv√°lido');
                if (errorEl) errorEl.textContent = 'CEP deve ter 8 d√≠gitos';
                return;
            }
            
            buscarCEP(cep);
        });
        console.log('‚úÖ [INIT] Event listener do bot√£o buscar adicionado');
    } else {
        console.error('‚ùå [INIT] Bot√£o buscar n√£o encontrado!');
    }
    
    // M√°scara para celular
    if (celularInput) {
        celularInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                e.target.value = value;
            }
        });
    }
    
    // M√°scara para CEP
    if (cepInput) {
        cepInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 8) {
                value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
                e.target.value = value;
            }
        });
        
        // Auto buscar quando sair do campo
        cepInput.addEventListener('blur', function() {
            const cep = this.value.replace(/\D/g, '');
            if (cep.length === 8) {
                console.log('üîç [EVENT] Auto buscar CEP no blur:', cep);
                buscarCEP(cep);
            }
        });
    }
    
    // Controle da taxa de entrega
    const tipoEntregaInputs = document.querySelectorAll('input[name="tipo_entrega"]');
    const enderecoSection = document.getElementById('endereco-section');
    const taxaValue = document.getElementById('taxa-value');
    const totalFinal = document.getElementById('total-final');
    
    const subtotal = {{ total_carrinho|default:0 }};
    const taxaEntrega = {{ restaurante.taxa_entrega|default:0 }};
    
    function atualizarTotais() {
        const tipoSelecionado = document.querySelector('input[name="tipo_entrega"]:checked');
        if (!tipoSelecionado) return;
        
        if (tipoSelecionado.value === 'delivery') {
            if (enderecoSection) enderecoSection.style.display = 'block';
            if (taxaValue) taxaValue.textContent = 'R$ ' + taxaEntrega.toFixed(2);
            if (totalFinal) totalFinal.textContent = 'R$ ' + (subtotal + taxaEntrega).toFixed(2);
            
            // Tornar campos de endere√ßo obrigat√≥rios
            const campos = ['cep', 'logradouro', 'numero', 'bairro', 'cidade'];
            campos.forEach(campo => {
                const el = document.getElementById(campo);
                if (el) el.required = true;
            });
        } else {
            if (enderecoSection) enderecoSection.style.display = 'none';
            if (taxaValue) taxaValue.textContent = 'R$ 0,00';
            if (totalFinal) totalFinal.textContent = 'R$ ' + subtotal.toFixed(2);
            
            // Remover obrigatoriedade dos campos de endere√ßo
            const campos = ['cep', 'logradouro', 'numero', 'bairro', 'cidade'];
            campos.forEach(campo => {
                const el = document.getElementById(campo);
                if (el) el.required = false;
            });
        }
    }
    
    tipoEntregaInputs.forEach(input => {
        input.addEventListener('change', atualizarTotais);
    });
    
    // Inicializar
    atualizarTotais();
    
    // Controle do campo de troco
    const formasPagamento = document.querySelectorAll('input[name="forma_pagamento"]');
    const trocoSection = document.getElementById('troco-section');
    
    function mostrarTroco() {
        const formaSelecionada = document.querySelector('input[name="forma_pagamento"]:checked');
        if (trocoSection && formaSelecionada) {
            trocoSection.style.display = formaSelecionada.value === 'dinheiro' ? 'block' : 'none';
        }
    }
    
    formasPagamento.forEach(input => {
        input.addEventListener('change', mostrarTroco);
    });
    
    // Inicializar
    mostrarTroco();
    
    // Valida√ß√£o do formul√°rio
    const checkoutForm = document.getElementById('checkout-form');
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            const tipoEntrega = document.querySelector('input[name="tipo_entrega"]:checked');
            
            if (tipoEntrega && tipoEntrega.value === 'delivery') {
                const cep = document.getElementById('cep').value.replace(/\D/g, '');
                if (cep.length !== 8) {
                    e.preventDefault();
                    alert('Por favor, informe um CEP v√°lido');
                    document.getElementById('cep').focus();
                    return;
                }
            }
            
            const formaPagamento = document.querySelector('input[name="forma_pagamento"]:checked');
            if (formaPagamento && formaPagamento.value === 'dinheiro') {
                const trocoParaInput = document.getElementById('troco_para');
                if (trocoParaInput) {
                    const trocoValue = parseFloat(trocoParaInput.value) || 0;
                    const total = tipoEntrega && tipoEntrega.value === 'delivery' ? subtotal + taxaEntrega : subtotal;
                    
                    if (trocoValue > 0 && trocoValue < total) {
                        e.preventDefault();
                        alert('O valor do troco deve ser maior que o total do pedido');
                        trocoParaInput.focus();
                        return;
                    }
                }
            }
        });
    }
    
    // Fun√ß√£o de teste global
    window.testarCEP = function() {
        console.log('üß™ [TEST] === TESTE MANUAL DE CEP ===');
        buscarCEP('01310100');
    };
    
    // Testar clique direto no bot√£o
    window.testarBotaoCEP = function() {
        console.log('üß™ [TEST-BOTAO] === TESTE DIRETO DO BOT√ÉO ===');
        const cepInput = document.getElementById('cep');
        const buscarBtn = document.getElementById('buscar-cep');
        
        if (cepInput) {
            cepInput.value = '01310-100';
            console.log('üß™ [TEST-BOTAO] CEP preenchido:', cepInput.value);
        }
        
        if (buscarBtn) {
            console.log('üß™ [TEST-BOTAO] Clicando no bot√£o...');
            buscarBtn.click();
        } else {
            console.error('üß™ [TEST-BOTAO] Bot√£o n√£o encontrado!');
        }
    };
    
    // Fun√ß√£o de teste mais simples para debug
    window.testarCEPSimples = function() {
        console.log('üß™ [TEST-SIMPLES] === TESTE DIRETO ===');
        
        const loadingEl = document.querySelector('.loading-cep');
        const errorEl = document.querySelector('.cep-error');
        
        console.log('üß™ [TEST-SIMPLES] Loading element:', loadingEl);
        console.log('üß™ [TEST-SIMPLES] Error element:', errorEl);
        
        if (loadingEl) {
            loadingEl.style.display = 'block';
            console.log('üß™ [TEST-SIMPLES] Loading exibido');
        }
        
        fetch('https://viacep.com.br/ws/01310100/json/')
            .then(response => {
                console.log('üß™ [TEST-SIMPLES] Response:', response);
                return response.json();
            })
            .then(data => {
                console.log('üß™ [TEST-SIMPLES] Data:', data);
                if (loadingEl) loadingEl.style.display = 'none';
                if (errorEl) errorEl.innerHTML = '<span style="color: green;">‚úÖ Teste OK: ' + data.logradouro + '</span>';
            })
            .catch(error => {
                console.error('üß™ [TEST-SIMPLES] Erro:', error);
                if (loadingEl) loadingEl.style.display = 'none';
                if (errorEl) errorEl.textContent = 'Erro: ' + error.message;
            });
    };
    
    // Fun√ß√£o para verificar se h√° conflitos com outros scripts
    window.verificarConflitos = function() {
        console.log('üîç [DEBUG] === VERIFICA√á√ÉO DE CONFLITOS ===');
        console.log('üîç [DEBUG] fetch dispon√≠vel:', typeof fetch);
        console.log('üîç [DEBUG] Promise dispon√≠vel:', typeof Promise);
        console.log('üîç [DEBUG] AbortController dispon√≠vel:', typeof AbortController);
        console.log('üîç [DEBUG] setTimeout dispon√≠vel:', typeof setTimeout);
        console.log('üîç [DEBUG] clearTimeout dispon√≠vel:', typeof clearTimeout);
        console.log('üîç [DEBUG] console dispon√≠vel:', typeof console);
        console.log('üîç [DEBUG] document dispon√≠vel:', typeof document);
        console.log('üîç [DEBUG] window dispon√≠vel:', typeof window);
        
        // Verificar elementos DOM
        console.log('üîç [DEBUG] === VERIFICA√á√ÉO DOM ===');
        console.log('üîç [DEBUG] CEP input:', !!document.getElementById('cep'));
        console.log('üîç [DEBUG] Loading div:', !!document.querySelector('.loading-cep'));
        console.log('üîç [DEBUG] Error div:', !!document.querySelector('.cep-error'));
        console.log('üîç [DEBUG] Buscar button:', !!document.getElementById('buscar-cep'));
        
        // Verificar se h√° outros event listeners
        const cepInput = document.getElementById('cep');
        if (cepInput) {
            console.log('üîç [DEBUG] CEP input events:', cepInput);
        }
    };
    
    console.log('‚úÖ [INIT] Checkout inicializado com sucesso!');
    console.log('üí° [INFO] Digite testarCEPDireto() no console para testar');
    
    // M√°scara para celular
    const celularInput = document.getElementById('celular');
    if (celularInput) {
        celularInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                e.target.value = value;
            }
        });
    }
    
    // M√°scara para CEP
    const cepInputMask = document.getElementById('cep');
    if (cepInputMask) {
        cepInputMask.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 8) {
                value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
                e.target.value = value;
            }
        });
    }
    
    // Controle da taxa de entrega
    const tipoEntregaInputs = document.querySelectorAll('input[name="tipo_entrega"]');
    const enderecoSection = document.getElementById('endereco-section');
    const taxaValue = document.getElementById('taxa-value');
    const totalFinal = document.getElementById('total-final');
    
    const subtotal = {{ total_carrinho|default:0 }};
    const taxaEntrega = {{ restaurante.taxa_entrega|default:0 }};
    
    function atualizarTotais() {
        const tipoSelecionado = document.querySelector('input[name="tipo_entrega"]:checked');
        if (!tipoSelecionado) return;
        
        if (tipoSelecionado.value === 'delivery') {
            if (enderecoSection) enderecoSection.style.display = 'block';
            if (taxaValue) taxaValue.textContent = 'R$ ' + taxaEntrega.toFixed(2);
            if (totalFinal) totalFinal.textContent = 'R$ ' + (subtotal + taxaEntrega).toFixed(2);
            
            // Tornar campos de endere√ßo obrigat√≥rios
            const campos = ['cep', 'logradouro', 'numero', 'bairro', 'cidade'];
            campos.forEach(campo => {
                const el = document.getElementById(campo);
                if (el) el.required = true;
            });
        } else {
            if (enderecoSection) enderecoSection.style.display = 'none';
            if (taxaValue) taxaValue.textContent = 'R$ 0,00';
            if (totalFinal) totalFinal.textContent = 'R$ ' + subtotal.toFixed(2);
            
            // Remover obrigatoriedade dos campos de endere√ßo
            const campos = ['cep', 'logradouro', 'numero', 'bairro', 'cidade'];
            campos.forEach(campo => {
                const el = document.getElementById(campo);
                if (el) el.required = false;
            });
        }
    }
    
    tipoEntregaInputs.forEach(input => {
        input.addEventListener('change', atualizarTotais);
    });
    
    // Inicializar
    atualizarTotais();
    
    // Controle do campo de troco
    const formasPagamento = document.querySelectorAll('input[name="forma_pagamento"]');
    const trocoSection = document.getElementById('troco-section');
    
    function mostrarTroco() {
        const formaSelecionada = document.querySelector('input[name="forma_pagamento"]:checked');
        if (trocoSection && formaSelecionada) {
            trocoSection.style.display = formaSelecionada.value === 'dinheiro' ? 'block' : 'none';
        }
    }
    
    formasPagamento.forEach(input => {
        input.addEventListener('change', mostrarTroco);
    });
    
    // Inicializar
    mostrarTroco();
    
    // Valida√ß√£o do formul√°rio
    const checkoutForm = document.getElementById('checkout-form');
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            const tipoEntrega = document.querySelector('input[name="tipo_entrega"]:checked');
            
            if (tipoEntrega && tipoEntrega.value === 'delivery') {
                const cep = document.getElementById('cep').value.replace(/\D/g, '');
                if (cep.length !== 8) {
                    e.preventDefault();
                    alert('Por favor, informe um CEP v√°lido');
                    document.getElementById('cep').focus();
                    return;
                }
            }
            
            const formaPagamento = document.querySelector('input[name="forma_pagamento"]:checked');
            if (formaPagamento && formaPagamento.value === 'dinheiro') {
                const trocoParaInput = document.getElementById('troco_para');
                if (trocoParaInput) {
                    const trocoValue = parseFloat(trocoParaInput.value) || 0;
                    const total = tipoEntrega && tipoEntrega.value === 'delivery' ? subtotal + taxaEntrega : subtotal;
                    
                    if (trocoValue > 0 && trocoValue < total) {
                        e.preventDefault();
                        alert('O valor do troco deve ser maior que o total do pedido');
                        trocoParaInput.focus();
                        return;
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
